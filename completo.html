<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>D3 Test</title>
        <script type="text/javascript" src="http://d3js.org/d3.v3.min.js"></script>
        <script src="http://d3js.org/topojson.v1.min.js"></script>
        <link rel="stylesheet" type="text/css" href="css/completo.css">
        <link rel="stylesheet" type="text/css" href="css/estructura.css">
        <link rel="stylesheet" type="text/css" href="css/navbar.css">
        <script src="http://code.jquery.com/jquery-latest.min.js" type="text/javascript"></script>
		<script src="js/script.js"></script>
    </head>
    <body>
    	<div id="cssmenu">
    		<ul id="nav_menu">
    			<li><a href="index.html"><span>Home</span></a></li>
				<li><a href="tutorial.html"><span>Tutorial</span></a></li>
				<li><a href="primera.html"><span>Primera</span></a></li>
				<li><a href="segunda.html"><span>Segunda</span></a></li>
				<li><a href="ultima.html"><span>Ultima</span></a></li>
				<li class="last active"><a href="completo.html"><span>Com</span></a></li>
			</ul>
		</div>
		<div id="div_title">
			<h1 id="title">Completo</h1>
		</div>
		<script>
		//Width and height
	        
			var width = 960,
				height = 400;
			
			var projection = d3.geo.mercator()
			    .center([0, 40])
			    .scale(100)
			    .translate([width / 3, height/1.75]);
			
			var path = d3.geo.path()
			    .projection(projection)
			    .pointRadius(2);
			
			var div = d3.select("body").append("div")
				.attr("id","primero");
			
			var svg = div.append("svg")
			    .attr("width", width)
			    .attr("height", height)
				.attr("id","svg_p");
			
			d3.json("json/world.topo.json", function(error, world) {
				
				d3.json("json/paisos.json", function(json) {
					update(json);
				});
				
				function update (data){
					
					svg = d3.select("#svg_p");
					
					svg.selectAll(".subunits")
						.data(topojson.feature(world, world.objects.subunits).features)
						.enter().append("path")
						.attr("class", function(d) {
							for(var i=0;i<data.length;i++){
								if(data[i].id == d.id){
									return "subunit " + d.id + " " + data[i].continente;
								}
							}
							return "subunit " + d.id; 
						})
						.attr("d", path)
						.on("click",click)
						.on("mouseover", mouseover)
						.on("mouseleave",mouseleave);
					
					svg.append("path")
						.datum(topojson.mesh(world, world.objects.subunits, function(a, b) { return a !== b}))
						.attr("d", path)
						.attr("class", "subunit-boundary");			
				}
				
				
				function mouseover (){
					var subunit = d3.select(this);
					subunit
						.style("opacity",0.3);
				}
				
				function mouseleave (){
					var subunit = d3.select(this);
					subunit
						.style("opacity",1);
				}
				
				function click(){
					var subunit = d3.select(this);
					if(subunit.attr("class") == "subunit ESP europa"){
						redraw();
					}
					else{
						alert("not spain");
					}
				}
				
				function redraw(){
					
					svg = d3.select("#svg_p");
					
					svg.remove();
					
					width = 960,
					height = 1160;
					
					svg = div.append("svg")
						.attr("width", width)
						.attr("height", height)
						.attr("id","svg_p");
					
					projection = d3.geo.albers()
						.center([0, 40])
						.rotate([4.4, 0])
						.parallels([50, 60])
						.scale(1200 * 3)
						.translate([width / 3, height / 3]);
			
					path = d3.geo.path()
						.projection(projection)
						.pointRadius(2);				
			
			
					d3.json("json/spain.topo.json", function(error, spain) {
						
						svg = d3.select("#svg_p");
						
						svg.selectAll(".subunit")
							.data(topojson.feature(spain, spain.objects.subunits).features)
							.enter().append("path")
							.attr("class", function(d) { return "subunit " + d.id; })
							.attr("d", path);
			
						svg.append("path")
							.datum(topojson.mesh(spain, spain.objects.subunits, function(a, b) { return true; }))
							.attr("d", path)
							.attr("class", "subunit-boundary");
		  	
						svg.selectAll(".provinces")
							.data(topojson.feature(spain, spain.objects.provinces).features)
							.enter().append("path")
							.attr("class", function(d,i) { 
								if (i==9 || i==16 || i==36 || i==12 || i==26){ return "province colored";}
								else return "province else";
							})
							.attr("d", path);
				
						svg.append("path")
							.datum(topojson.mesh(spain, spain.objects.provinces, function(a, b) { return a !== b; }))
							.attr("d", path)
							.attr("class", "provinces-boundary");
				
						svg.selectAll(".places")
							.data(topojson.feature(spain, spain.objects.places).features)
							.enter().append("path")
							.attr("class", function(d) { return "place " + d.properties.name; })
							.attr("d", path);
				
						svg.selectAll(".place-label")
							.data(topojson.feature(spain, spain.objects.places).features)
							.enter().append("text")
							.attr("class", "place-label")
							.attr("transform", function(d) { return "translate(" + projection(d.geometry.coordinates) + ")"; })
							.attr("x", function(d) { return d.geometry.coordinates[0] > -1 ? 6 : -6; })
							.attr("dy", ".35em")
							.style("text-anchor", function(d) { return d.geometry.coordinates[0] > -1 ? "start" : "end"; })
							.text(function(d) { return d.properties.name; });
					});
				}
			});
		</script>
		<div id="segundo">
			<button id="button">Update</button>
		</div>
		<script>
			var width = 960;
			var height = 400;
			var i_pais,j_pais,nElem;
			
			var projection = d3.geo.mercator()
			    .center([0, 40])
			    .scale(100)
			    .translate([width / 3, height/1.75]);
			
			var path = d3.geo.path()
			    .projection(projection)
			    .pointRadius(2);
			
			var div = d3.select("#segundo");
			
			var svg = div.append("svg")
			    .attr("width", width)
			    .attr("height", height)
				.attr("id","svg_s");
			
			d3.json("json/world.topo.json", function(error, world) {
				
				d3.json("json/paisos.temp.json", function(json) {
					update(json);
				});
				
				function update (data){
					
					nElem = data[0].datos.length;
					
					svg = d3.select("#svg_s");
					
					svg.selectAll(".subunits")
						.data(topojson.feature(world, world.objects.subunits).features)
						.enter().append("path")
						.attr("class", function(d) {
							for(var i=0;i<data.length;i++){
								if(data[i].id == d.id){
									var tono = ''+data[i].datos[0].riqueza.length;
									switch(tono){
										case "1":
											return "subunit " + d.id + " " + "primero";
											break;
										case "2":
											return "subunit " + d.id + " " + "segundo";
											break;
										case "3":
											return "subunit " + d.id + " " + "tercero";
											break;
										case "4":
											return "subunit " + d.id + " " + "cuarto";
											break;
									}
								}
							}
							return "subunit " + d.id; 
						})
						.attr("d", path)
						.on("mouseover", mouseover)
						.on("mouseleave",mouseleave);
					
					svg.append("path")
						.datum(topojson.mesh(world, world.objects.subunits, function(a, b) { return a !== b}))
						.attr("d", path)
						.attr("class", "subunit-boundary");

					var button = d3.select("#button");
				
					button
						.on("click",function(){
							transitions();
						});
				
					function transitions(){
						i_pais = 2;
						j_pais = 2 * nElem;
						
						var subunits = svg.selectAll(".subunit")
							.filter(function(d){
								for(var i=0;i<data.length;i++){
									if(data[i].id == d.id ){
										return true
									}
								}
								return false;
							})
						
						subunits.transition()
							.style("fill",function(d){
								for(var i=0;i<data.length;i++){
									if(data[i].id == d.id){
										var tono = ''+data[i].datos[1].riqueza.length;
										switch(tono){
											case "1":
												return "#f9b966";
												break;
											case "2":
												return "#ce5f2d";
												break;
											case "3":
												return "#50232e";
												break;
											case "4":
												return "#FF8C00";
												break;
										}
									}
								}
							})
							.duration(500)
							.delay(100)
							.each("end",repeat);
					}
							
					
					function repeat(){
						if(i_pais<data[0].datos.length){
							d3.select(this).transition()
								.style("fill",function(d){
									console.log("entra");
									return "green";
								})
								.duration(3000) // this is 1s
								.delay(100);
						}
					}
				}
				

				function mouseover (){
					var subunit = d3.select(this);
					subunit
						.style("opacity",0.3);
				}
				
				function mouseleave (){
					var subunit = d3.select(this);
					subunit
						.style("opacity",1);
				}				
			});
		
		</script>
        <div id="footer">
			<p> Alejandro Cortes Cabrejas</p>
			<p> Follow him on gitHub as @Calexx</p>
		</div>
	</body>
</html>