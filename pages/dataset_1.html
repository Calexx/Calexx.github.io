<html lang="es">
    <head>
		<script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.4.4/underscore-min.js"></script>
		<link rel="stylesheet" type="text/css" href="css/dataset.css">
		<script src="js/diccionario_europa.js"></script>
    </head>
    <body>
		<script>
			var nElem = 0;
			var width = 600,
				height = 800;
			var padding = 40;
			var i_pais,j_pais;
				
			var div = d3.select("#panel_1-body");
			
			var projection = d3.geo.mercator()
			    .center([0, 40])
			    .scale(600)
			    .translate([width / 3, height/1.25]);
			
			var path = d3.geo.path()
			    .projection(projection)
			    .pointRadius(2);
				
			var svg = div
				.append("svg")
				.attr("id","europe_svg")
				.attr("width", width)
			    .attr("height", height)
				
			d3.json("json/europe.topo.json", function(error, europe) {
				
				d3.json("json/I+D_europe.json", function(json) {
					update(json);
				});
				
				function update(json){
				
					var data = pivotID(json);
					
					var dic = crearDiccionarioEuropa();
					
					var yearsSort = Object.keys(data[Object.keys(data)[0]][Object.keys(data[Object.keys(data)[0]])[0]]).sort();
					
					var initialValues = {};
					
					for (key in data){
						if (_.contains(Object.keys(dic), key)){
							initialValues[key] = data[key]["All sectors"][yearsSort[0]][0]["Value"];
						}
					}
					
					// Euro Per Capita in RESEARCH
					svg.selectAll(".subunits")
						.data(topojson.feature(europe, europe.objects.regions).features.filter(function(d){
							if(d.properties.NUTS_ID.length == 2){
								return true;
							}
							else return false;
						}))
						.enter().append("path")
						.attr("d", path)
						.attr("class", function(d){
							for (key in data){
								if (dic[key] == d.properties.NUTS_ID.substring(0,2)){
									var tono = data[key]["All sectors"][yearsSort[0]][0]["Value"];
									if(tono<100){
										return "subunit " + key + " " + "primero";
									}
									else if (tono<500){
										return "subunit " + key + " " + "segundo";
									}
									else if (tono<1000){
										return "subunit " + key + " " + "tercero";
									}
									else{
										return "subunit " + key + " " + "cuarto";
									}
								}
							}
						})
						.each(function(){
							nElem++;
						});
						
					svg.append("path")
						//.datum(topojson.mesh(europe, europe.objects.regions, function(a, b) { return a !== b}))
						.datum(topojson.mesh(europe, europe.objects.regions, function(d) {
							if(d.properties.NUTS_ID.length == 2){
								return true;
							}
							else return false;
						}))
						.attr("d", path)
						.attr("class", "subunit-boundary");
						
					svg.append("text")
						.attr("id","sector")
						.text(function(){
							var pais = Object.keys(data)[0];
							var sector = Object.keys(data[pais])[0];
							return sector;
						})
						.attr("x", padding)
						.attr("y", padding);
						
					svg.append("text")
						.attr("id","year")
						.text(function(){
							var pais = Object.keys(data)[0];
							var sector = Object.keys(data[pais])[0];
							var year = Object.keys(data[pais][sector]).sort()[0];
							return year;
						})
						.attr("x", padding*10+30)
						.attr("y", padding);
					
					var button = d3.select(".myButton");
				
					button
						.on("click",function(){
							transitions();
						});
						
					function transitions(){
						i_pais = 2;
						j_pais = 2 * nElem;
						i_year = 2;
						
						var subunits = svg.selectAll(".subunit");
						var year = svg.select("#year");
						
						subunits.transition()
							.style("fill",function(d){
								for(key in data){
									if (dic[key] == d.properties.NUTS_ID.substring(0,2)){
										var tono = initialValues[key]-data[key]["All sectors"][yearsSort[1]][0]["Value"];
										if(tono<0){
											var qual = initialValues[key]/Math.abs(tono);
											if(qual<10){
												return "#FAE6E7"
											}
											else if (qual<20){
												return "#E98E95"
											}
											else{
												return "#D93A46";
											}
										}
										else if (tono>0){
											var qual = initialValues[key]/Math.abs(tono);
											if(qual<10){
												return "#E9F2F5"
											}
											else if (qual<20){
												return "#93B8C3"
											}
											else{
												return "#3F7F93";
											}
										}
										else{
											return "#F2F2F2";
										}
									}
								}
							})
							.duration(1000)
							.delay(300)
							.each("end",repeat);
							
						year.transition()
							.text(yearsSort[1])
							.duration(1000) // this is 1s
							.delay(500)
							.each("end",repeatYear);
					}
					
					function repeat(){
						i_pais = parseInt(j_pais/nElem);
						//ultima transicion o no
						if(i_pais<yearsSort.length+1){
							//ultimo año
							if(i_pais == yearsSort.length){
								d3.select(this).transition()
									.style("fill",function(d){
										for(key in data){
											if (dic[key] == d.properties.NUTS_ID.substring(0,2)){
												var tono = data[key]["All sectors"][yearsSort[0]][0]["Value"];
												if(tono<0){
													var qual = initialValues[key]/Math.abs(tono);
													if(qual<10){
														return "#F2F2F2"
													}
													else if (qual<20){
														return "#F2F2F2"
													}
													else{
														return "#F2F2F2";
													}
												}
												else if (tono>0){
													var qual = initialValues[key]/Math.abs(tono);
													if(qual<10){
														return "#F2F2F2"
													}
													else if (qual<20){
														return "#F2F2F2"
													}
													else{
														return "#F2F2F2";
													}
												}
												else{
													return "#F2F2F2";
												}
											}
										}
									})
									.duration(1000) // this is 1s
									.delay(5000);
								j_pais++;
							}
							else{
								d3.select(this).transition()
									.style("fill",function(d){
										for(key in data){
											if (dic[key] == d.properties.NUTS_ID.substring(0,2)){
												var tono = initialValues[key]-data[key]["All sectors"][yearsSort[i_pais]][0]["Value"];
												if(tono<0){
													var qual = initialValues[key]/Math.abs(tono);
													if(qual<10){
														return "#FAE6E7"
													}
													else if (qual<20){
														return "#E98E95"
													}
													else{
														return "#D93A46";
													}
												}
												else if (tono>0){
													var qual = initialValues[key]/Math.abs(tono);
													if(qual<10){
														return "#E9F2F5"
													}
													else if (qual<20){
														return "#93B8C3"
													}
													else{
														return "#3F7F93";
													}
												}
												else{
													return "#F2F2F2";
												}
											}
										}
									})
									.duration(1000) // this is 1s
									.delay(300)
									.each("end",repeat);
								j_pais++;
							}
						}
					}
					
					function repeatYear(){
						if(i_year<yearsSort.length+1){
							if(i_year==yearsSort.length){
								d3.select(this).transition()
									.text(yearsSort[0])
									.duration(1000) // this is 1s
									.delay(5000);
								i_year++;
							}
							else{
								d3.select(this).transition()
									.text(yearsSort[i_year])
									.duration(1000) // this is 1s
									.delay(300)
									.each("end",repeatYear);
								i_year++;
							}
						}
					}
					
					var h_leyenda = height/4;
			
					var svg_leyenda = div
						.append("svg")
						.attr("width", width/2)
						.attr("height", h_leyenda)
						.attr("class","leyenda");
					svg_leyenda
						.append("rect")
						.attr("x",padding)
						.attr("y",padding)
						.attr("width", 20)
						.attr("height", 10)
						.attr("fill", "#5ebdb2");
					svg_leyenda
						.append("rect")
						.attr("x",padding)
						.attr("y",padding*2)
						.attr("width", 20)
						.attr("height", 10)
						.attr("fill", "#e47c5d");
					svg_leyenda
						.append("rect")
						.attr("x",padding)
						.attr("y",padding*3)
						.attr("width", 20)
						.attr("height", 10)
						.attr("fill", "#e42d40");
					svg_leyenda
						.append("rect")
						.attr("x",padding)
						.attr("y",padding*4)
						.attr("width", 20)
						.attr("height", 10)
						.attr("fill", "#142b3b");
					svg_leyenda
						.append("text")
						.attr("x", padding)
						.attr("y", padding-10*2)
						.attr("font-size", "10px")
						.attr("fill","black")
						.text("I+D inversion");
					svg_leyenda
						.append("text")
						.attr("x", padding*2)
						.attr("y", padding+10)
						.attr("font-size", "10px")
						.attr("fill","black")
						.text("0-100 M. €");
					svg_leyenda
						.append("text")
						.attr("x", padding*2)
						.attr("y", padding*2+10)
						.attr("font-size", "10px")
						.attr("fill","black")
						.text("101-500 M. €");
					svg_leyenda
						.append("text")
						.attr("x", padding*2)
						.attr("y", padding*3+10)
						.attr("font-size", "10px")
						.attr("fill","black")
						.text("501-1000 M. €");
					svg_leyenda
						.append("text")
						.attr("x", padding*2)
						.attr("y", padding*4+10)
						.attr("font-size", "10px")
						.attr("fill","blac		k")
						.text("> 1000 M. €");
				}
	
			});
			
			function pivotID(json){
			
				_.groupByMulti = function (obj, values, context) {
					if (!values.length)
						return obj;
					var byFirst = _.groupBy(obj, values[0], context),
						rest = values.slice(1);
					for (var prop in byFirst) {
						byFirst[prop] = _.groupByMulti(byFirst[prop], rest, context);
					}
					return byFirst;
				};

				var result = _.groupByMulti(json, ['GEO','SECTPERF','TIME']);
			
				return result;
			}
			
			
		</script>
	</body>
</html>